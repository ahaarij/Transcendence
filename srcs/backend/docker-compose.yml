version: '3.8'

services:
  # auth service handles authentication and 2fa
  auth:
    build:
      context: .
      dockerfile: auth/Dockerfile
    container_name: transcendence-auth
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=file:/app/data/dev.db
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    volumes:
      - sqlite-data:/app/data
      - ./prisma:/app/prisma
    networks:
      - transcendence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/auth/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # user service manages user profiles and avatars
  user:
    build:
      context: .
      dockerfile: user/Dockerfile
    container_name: transcendence-user
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DATABASE_URL=file:/app/data/dev.db
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - AUTH_SERVICE_URL=http://auth:3001
    volumes:
      - sqlite-data:/app/data
      - ./prisma:/app/prisma
      - ./public:/app/public
    networks:
      - transcendence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/user/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - auth

  # game service records match results and stats
  game:
    build:
      context: .
      dockerfile: game/Dockerfile
    container_name: transcendence-game
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - DATABASE_URL=file:/app/data/dev.db
      - AUTH_SERVICE_URL=http://auth:3001
    volumes:
      - sqlite-data:/app/data
      - ./prisma:/app/prisma
    networks:
      - transcendence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/game/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - auth

  # websocket gateway for real time game communication
  ws-gateway:
    build:
      context: .
      dockerfile: ws-gateway/Dockerfile
    container_name: transcendence-ws
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=production
      - WS_PORT=3004
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - AUTH_SERVICE_URL=http://auth:3001
    networks:
      - transcendence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/ws/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - auth

# shared sqlite database for all services
volumes:
  sqlite-data:
    driver: local

# internal network for service to service communication
networks:
  transcendence-network:
    driver: bridge
