# nginx configuration for transcendence with ssl/tls support
# handles ssl termination and reverse proxying to backend and frontend services

# defines number of worker processes (auto = number of cpu cores)
worker_processes auto;

events {
    # maximum number of simultaneous connections per worker
    worker_connections 1024;
}

http {
    # includes mime types for proper content type headers
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # logging configuration
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # optimizes file transmission
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # connection timeout settings
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # hides nginx version for security
    server_tokens off;

    # ssl/tls security configuration
    ssl_protocols TLSv1.2 TLSv1.3;  # only secure protocols
    ssl_prefer_server_ciphers on;  # server chooses cipher
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_session_cache shared:SSL:10m;  # session cache for performance
    ssl_session_timeout 10m;  # session timeout

    # websocket upgrade headers
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # http server - redirects all traffic to https
    server {
        listen 80;  # listens on http port
        server_name localhost;

        # redirects all http requests to https
        return 301 https://$server_name$request_uri;
    }

    # https server - main application server with ssl
    server {
        listen 443 ssl http2;  # listens on https port with http2 support
        server_name localhost;

        # ssl certificate paths (mounted from host)
        ssl_certificate /etc/nginx/ssl/server.crt;  # public certificate
        ssl_certificate_key /etc/nginx/ssl/server.key;  # private key

        # security headers for https
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;  # forces https for 1 year
        add_header X-Frame-Options "SAMEORIGIN" always;  # prevents clickjacking
        add_header X-Content-Type-Options "nosniff" always;  # prevents mime sniffing
        add_header X-XSS-Protection "1; mode=block" always;  # enables xss protection

        # proxies api requests to backend service
        location /auth/ {
            proxy_pass http://backend:3000;  # forwards to backend container
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;  # preserves client ip
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # proxy chain
            proxy_set_header X-Forwarded-Proto $scheme;  # original protocol
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
        }

        # proxies user service requests to backend
        location /user/ {
            proxy_pass http://backend:3000;  # forwards to backend container
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
        }

        # proxies game service requests to backend
        location /game/ {
            proxy_pass http://backend:3000;  # forwards to backend container
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
        }

        # proxies static file requests to backend
        location /public/ {
            proxy_pass http://backend:3000;  # forwards to backend container
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # proxies websocket connections to ws-gateway
        location /ws/ {
            proxy_pass http://ws-gateway:3004;  # forwards to websocket gateway
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;  # websocket upgrade
            proxy_set_header Connection $connection_upgrade;  # websocket connection
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 86400;  # 24 hour timeout for websockets
        }

        # serves frontend application
        location / {
            proxy_pass http://frontend:8080;  # forwards to frontend container
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
