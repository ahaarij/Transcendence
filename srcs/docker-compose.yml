version: '3.8'

services:
  # Nginx Reverse Proxy with SSL/TLS termination
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: transcendence-nginx
    ports:
      - "8080:80"    # http port (redirects to https) on host
      - "8443:443"   # https port (main application) on host
    volumes:
      - ./nginx/ssl:/etc/nginx/ssl:ro  # mounts ssl certificates
    networks:
      - transcendence-network
    depends_on:
      - backend
      - frontend
    restart: unless-stopped

  # Backend Service (Combined Auth + User on port 3000)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: transcendence-backend
    expose:
      - "3000"  # only exposed internally to nginx
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:./prisma/dev.db
      - PORT=3000
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - CORS_ORIGIN=https://localhost:8443
    volumes:
      - ./backend/prisma:/app/prisma
      - ./backend/public:/app/public
    networks:
      - transcendence-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/auth/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: transcendence-frontend
    expose:
      - "8080"  # only exposed internally to nginx
    environment:
      - VITE_GOOGLE_CLIENT_ID=${VITE_GOOGLE_CLIENT_ID}
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}
    networks:
      - transcendence-network
    volumes:
      - ./frontend:/app
      - /app/node_modules
    restart: unless-stopped
    depends_on:
      - backend

  # WebSocket Gateway Service
  ws-gateway:
    build:
      context: ./backend
      dockerfile: ws-gateway/Dockerfile
    container_name: transcendence-ws-gateway
    expose:
      - "3004"  # only exposed internally to nginx
    environment:
      - NODE_ENV=production
      - WS_PORT=3004
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
    networks:
      - transcendence-network
    restart: unless-stopped
    depends_on:
      - backend

networks:
  transcendence-network:
    driver: bridge

